var products = [
    {
        image: 'img-1-1.png',
        name: 'Cơm Cá Đỏ Sốt Teriyaki',
        price: '99,000',
        type: 'bento',
        masp: 'bento0'
    },
    {
        image: 'img-1-2.png',
        name: 'Cơm Bento Thịt Heo Chiên Xù Sốt Tonkatsu',
        price: '99,000',
        type: 'bento',
        masp: 'bento1'
    },
    {
        image: 'img-1-6.png',
        name: 'Cơm Cá Hồi Sốt Teriyaki',
        price: '159,000',
        type: 'bento',
        masp: 'bento2'
    },
    {
        image: 'img-1-7.png',
        name: 'Cơm Tôm Chiên Xù',
        price: '169,000',
        type: 'bento',
        masp: 'bento3'
    },
    {
        image: 'img-1-8.png',
        name: 'Cơm Hải Sản',
        price: '169,000',
        type: 'bento',
        masp: 'bento4'
    },
    {
        image: 'img-1-9.png',
        name: 'Cơm Lươn Nhật',
        price: '189,000',
        type: 'bento',
        masp: 'bento5'
    },
    {
        image: 'img-1-1.png',
        name: 'Cơm Cá Đỏ Sốt Teriyaki',
        price: '99,000',
        type: 'bento',
        masp: 'bento6'
    },
    {
        image: 'img-1-2.png',
        name: 'Cơm Bento Thịt Heo Chiên Xù Sốt Tonkatsu',
        price: '99,000',
        type: 'bento',
        masp: 'bento7'
    },
    {
        image: 'img-1-6.png',
        name: 'Cơm Cá Hồi Sốt Teriyaki',
        price: '159,000',
        type: 'bento',
        masp: 'bento8'
    },
    {
        image: 'img-1-7.png',
        name: 'Cơm Tôm Chiên Xù',
        price: '169,000',
        type: 'bento',
        masp: 'bento9'
    },
    {
        image: 'img-1-8.png',
        name: 'Cơm Hải Sản',
        price: '169,000',
        type: 'bento',
        masp: 'bento10'
    },
    {
        image: 'img-1-9.png',
        name: 'Cơm Lươn Nhật',
        price: '189,000',
        type: 'bento',
        masp: 'bento11'
    },
    {
        image: 'img-0-1.png',
        name: 'Tempura Roll',
        price: '118,000',
        type: 'sushi',
        masp: 'sushi0'
    },
    {
        image: 'img-0-2.png',
        name: 'Grilled Salmon Roll',
        price: '129,000',
        type: 'sushi',
        masp: 'sushi1'
    },
    {
        image: 'img-0-3.png',
        name: 'Kani Crunchy Roll',
        price: '153,000',
        type: 'sushi',
        masp: 'sushi2'
    },
    {
        image: 'img-1-1.png',
        name: 'Cơm Cá Đỏ Sốt Teriyaki',
        price: '99,000',
        type: 'bento',
        masp: 'bento12'
    },
    {
        image: 'img-0-4.png',
        name: 'Soft Shell Crab Roll',
        price: '168,000',
        type: 'sushi',
        masp: 'sushi3'
    },
    {
        image: 'img-0-5.png',
        name: 'Avocado Roll',
        price: '95,000',
        type: 'sushi',
        masp: 'sushi4'
    },
    {
        image: 'img-0-6.png',
        name: 'Tokachi Grilled Roll',
        price: '159,000',
        type: 'sushi',
        masp: 'sushi5'
    },
    {
        image: 'img-0-7.png',
        name: 'Unagi Roll',
        price: '280,000',
        type: 'sushi',
        masp: 'sushi6'
    },
    {
        image: 'img-0-8.png',
        name: 'Spicy Ebi Roll',
        price: '118,000',
        type: 'sushi',
        masp: 'sushi7'
    },
    {
        image: 'img-0-9.png',
        name: 'Cơm Cuộn Rồng Xanh',
        price: '79,000',
        type: 'sushi',
        masp: 'sushi8'
    },
    {
        image: 'img-0-10.png',
        name: 'Cơm Cuộn California',
        price: '139,000',
        type: 'sushi',
        masp: 'sushi9'
    },
    {
        image: 'img-0-11.png',
        name: 'Cơm Cuộn Cá Hồi Nướng Tái',
        price: '139,000',
        type: 'sushi',
        masp: 'sushi10'
    },
    {
        image: 'img-0-12.png',
        name: 'Cơm Cuộn Tôm Chiên Tempura',
        price: '179,000',
        type: 'sushi',
        masp: 'sushi11'
    },
    {
        image: 'img-0-13.png',
        name: 'Cơm Cuộn Cầu Vồng',
        price: '179,000',
        type: 'sushi',
        masp: 'sushi12'
    },
    {
        image: 'img-0-14.png',
        name: 'Cơm Cuộn Lươn Phô Mai',
        price: '199,000',
        type: 'sushi',
        masp: 'sushi13'
    },
    {
        image: 'img-0-15.png',
        name: 'Cơm Cuộn Hải Sản',
        price: '199,000',
        type: 'sushi',
        masp: 'sushi14'
    },
    {
        image: 'img-2-1.png',
        name: 'Sashimi Ốc Bulot Ireland',
        price: '189,000',
        type: 'sashi',
        masp: 'sashi0'
    },
    {
        image: 'img-2-2.png',
        name: 'Sashimi Cá Chim Việt Nam',
        price: '199,000',
        type: 'sashi',
        masp: 'sashi1'
    },
    {
        image: 'img-2-3.png',
        name: 'Sashimi Cá Mú Việt Nam',
        price: '219,000',
        type: 'sashi',
        masp: 'sashi2'
    },
    {
        image: 'img-2-4.png',
        name: 'Sashimi Tôm Sú Việt Nam',
        price: '249,000',
        type: 'sashi',
        masp: 'sashi3'
    },
    {
        image: 'img-2-5.png',
        name: 'Sashimi Cá Bơn Hàn Quốc',
        price: '399,000',
        type: 'sashi',
        masp: 'sashi4'
    },
    {
        image: 'img-2-6.png',
        name: 'Sashimi Bào Ngư Hàn Quốc',
        price: '499,000',
        type: 'sashi',
        masp: 'sashi5'
    },
    {
        image: 'img-2-7.png',
        name: 'Sashimi Ốc Vòi Voi',
        price: '889,000',
        type: 'sashi',
        masp: 'sashi6'
    },
    {
        image: 'img-2-8.png',
        name: 'Sashimi Bạch Tuộc',
        price: '169,000',
        type: 'sashi',
        masp: 'sashi7'
    },
    {
        image: 'img-2-9.png',
        name: 'Sashimi Trứng Cá Hồi',
        price: '239,000',
        type: 'sashi',
        masp: 'sashi8'
    },
    {
        image: 'img-2-10.png',
        name: 'Sashimi Bụng Cá Cam',
        price: '299,000',
        type: 'sashi',
        masp: 'sashi9'
    },
    {
        image: 'img-2-11.png',
        name: 'Sashimi Bụng Cá Hồi',
        price: '219,000',
        type: 'sashi',
        masp: 'sashi10'
    },
    {
        image: 'img-2-12.png',
        name: 'Sashimi Cá Trích Ép Trứng Đỏ',
        price: '169,000',
        type: 'sashi',
        masp: 'sashi11'
    },
    {
        image: 'img-2-13.png',
        name: 'Sashimi Cá Trích Ép Trứng Vàng',
        price: '169,000',
        type: 'sashi',
        masp: 'sashi12'
    },
    {
        image: 'img-2-14.png',
        name: 'Sashimi Cồi Sò Điệp Nhật',
        price: '239,000',
        type: 'sashi',
        masp: 'sashi13'
    },
    {
        image: 'img-2-15.png',
        name: 'Sashimi Sò Đỏ Hokkigai',
        price: '239,000',
        type: 'sashi',
        masp: 'sashi14'
    },
    {
        image: 'img-2-16.png',
        name: 'Sashimi Trứng Cá Chuồn',
        price: '169,000',
        type: 'sashi',
        masp: 'sashi15'
    },
    {
        image: 'img-2-17.png',
        name: 'Sashimi Thân Cá Hồi',
        price: '199,000',
        type: 'sashi',
        masp: 'sashi16'
    },
    {
        image: 'img-2-2.png',
        name: 'Sashimi Cá Chim Việt Nam',
        price: '199,000',
        type: 'sashi',
        masp: 'sashi17'
    },
    {
        image: 'img-2-4.png',
        name: 'Sashimi Tôm Sú Việt Nam',
        price: '249,000',
        type: 'sashi',
        masp: 'sashi18'
    },
    {
        image: 'img-2-6.png',
        name: 'Sashimi Bào Ngư Hàn Quốc',
        price: '499,000',
        type: 'sashi',
        masp: 'sashi19'
    },
    {
        image: 'img-2-8.png',
        name: 'Sashimi Bạch Tuộc',
        price: '169,000',
        type: 'sashi',
        masp: 'sashi20'
    },
    {
        image: 'img-2-10.png',
        name: 'Sashimi Bụng Cá Cam',
        price: '299,000',
        type: 'sashi',
        masp: 'sashi21'
    },
    {
        image: 'img-3-1.png',
        name: 'Combo Sashimi 3A',
        price: '269,000',
        type: 'combo',
        masp: 'combo0'
    },
    {
        image: 'img-3-2.png',
        name: 'Combo Sashimi 3B',
        price: '289,000',
        type: 'combo',
        masp: 'combo1'
    },
    {
        image: 'img-3-3.png',
        name: 'Combo Sashimi 3C',
        price: '319,000',
        type: 'combo',
        masp: 'combo2'
    },
    {
        image: 'img-3-4.png',
        name: 'Combo Sashimi 3D',
        price: '349,000',
        type: 'combo',
        masp: 'combo3'
    },
    {
        image: 'img-3-5.png',
        name: 'Combo Sashimi 3E',
        price: '389,000',
        type: 'combo',
        masp: 'combo4'
    },
    {
        image: 'img-3-6.png',
        name: 'Combo Sashimi 3F',
        price: '598,000',
        type: 'combo',
        masp: 'combo5'
    },
    {
        image: 'img-3-7.png',
        name: 'Combo Sashimi 5A',
        price: '499,000',
        type: 'combo',
        masp: 'combo6'
    },
    {
        image: 'img-3-8.png',
        name: 'Combo Sashimi 5B',
        price: '549,000',
        type: 'combo',
        masp: 'combo7'
    },
    {
        image: 'img-3-9.png',
        name: 'Combo Sashimi 5C',
        price: '849,000',
        type: 'combo',
        masp: 'combo8'
    },
    {
        image: 'img-3-10.png',
        name: 'Combo Sashimi 5D',
        price: '749,000',
        type: 'combo',
        masp: 'combo9'
    },
    {
        image: 'img-3-11.png',
        name: 'Combo Sashimi 7A',
        price: '999,000',
        type: 'combo',
        masp: 'combo10'
    },
    {
        image: 'img-3-12.png',
        name: 'Combo Sashimi 7B',
        price: '999,000',
        type: 'combo',
        masp: 'combo11'
    },
    {
        image: 'img-3-13.png',
        name: 'Combo Sashimi 7C',
        price: '990,000',
        type: 'combo',
        masp: 'combo12'
    },
    {
        image: 'img-3-14.png',
        name: 'Combo Sashimi Hoàng Gia',
        price: '2,249,000',
        type: 'combo',
        masp: 'combo13'
    },
    {
        image: 'img-4-1.png',
        name: 'Bánh Xèo Nhật',
        price: '89,000',
        type: 'ankem',
        masp: 'ankem0'
    },
    {
        image: 'img-4-2.png',
        name: 'Cá Hồi Sốt Teriyaki',
        price: '99,000',
        type: 'ankem',
        masp: 'ankem1'
    },
    {
        image: 'img-4-3.png',
        name: 'Đậu Nành Nhật',
        price: '35,000',
        type: 'ankem',
        masp: 'ankem2'
    },
    {
        image: 'img-4-4.png',
        name: 'Gừng Hồng',
        price: '10,000',
        type: 'ankem',
        masp: 'ankem3'
    },
    {
        image: 'img-4-5.png',
        name: 'Lá Tía Tô',
        price: '10,000',
        type: 'ankem',
        masp: 'ankem4'
    },
    {
        image: 'img-4-6.png',
        name: 'Lẩu Hải Sản Cay',
        price: '399,000',
        type: 'ankem',
        masp: 'ankem5'
    },
    {
        image: 'img-4-7.png',
        name: 'Mì Udon Hải Sản Cay',
        price: '199,000',
        type: 'ankem',
        masp: 'ankem6'
    },
    {
        image: 'img-4-8.png',
        name: 'Rong Nho',
        price: '99,000',
        type: 'ankem',
        masp: 'ankem7'
    },
    {
        image: 'img-4-9.png',
        name: 'Salad Cá Hồi Da Giòn',
        price: '119,000',
        type: 'ankem',
        masp: 'ankem8'
    },
    {
        image: 'img-4-10.png',
        name: 'Salad Hải Sản Sốt Hành Tây',
        price: '169,000',
        type: 'ankem',
        masp: 'ankem9'
    },
    {
        image: 'img-4-11.png',
        name: 'Salad Wakame',
        price: '69,000',
        type: 'ankem',
        masp: 'ankem10'
    },
    {
        image: 'img-4-12.png',
        name: 'Soup Miso Đầu Cá Bơn',
        price: '79,000',
        type: 'ankem',
        masp: 'ankem11'
    },
    {
        image: 'img-4-13.png',
        name: 'Soup Miso Đầu Cá Chim',
        price: '79,000',
        type: 'ankem',
        masp: 'ankem12'
    },
    {
        image: 'img-4-14.png',
        name: 'Soup Miso Đầu Cá Hồi',
        price: '79,000',
        type: 'ankem',
        masp: 'ankem13'
    },
    {
        image: 'img-4-15.png',
        name: 'Wasabi Tươi',
        price: '10,000',
        type: 'ankem',
        masp: 'ankem14'
    },
    {
        image: 'img-5-1.png',
        name: 'Coca-Cola',
        price: '10,000',
        type: 'douong',
        masp: 'douong0'
    },
    {
        image: 'img-5-2.png',
        name: 'Nước Suối Dasani',
        price: '10,000',
        type: 'douong',
        masp: 'douong1'
    },
    {
        image: 'img-5-3.png',
        name: 'Tàu Hủ Tươi Sentofu - Vị Đào',
        price: '19,000',
        type: 'douong',
        masp: 'douong2'
    },
    {
        image: 'img-5-4.png',
        name: 'Tàu Hủ Tươi Sentofu - Vị Dâu',
        price: '19,000',
        type: 'douong',
        masp: 'douong3'
    },
    {
        image: 'img-5-5.png',
        name: 'Tàu Hủ Tươi Sentofu - Vị Lá Dứa',
        price: '19,000',
        type: 'douong',
        masp: 'douong4'
    },
    {
        image: 'img-5-6.png',
        name: 'Tàu Hủ Tươi Sentofu - Vị Truyền Thống',
        price: '19,000',
        type: 'douong',
        masp: 'douong5'
    },
    {
        image: 'img-5-7.png',
        name: 'Tàu Hủ Tươi Sentofu - Vị Việt Quất',
        price: '19,000',
        type: 'douong',
        masp: 'douong6'
    }
]

// Cắt ảnh
function splitImg(img) {
    var img2 = img.split('fakepath\\');
    if(img2.length === 1) {
        return './images/' + img2;
    }
    else {
        return './images/' + img2[1];
    }
}

// Set mặc định cho product
const Products = localStorage.getItem('product') ? JSON.parse(localStorage.getItem('product')) : products;

if(Products === products) {
    localStorage.setItem("product", JSON.stringify(Products))
}

// Trả về loại sp
var typeList = ['bento', 'sushi', 'sashi', 'combo', 'ankem', 'douong'];
function getProducts(s) {   
    var arr = [];
    for(let i=0; i < Products.length; i++) {
        if(Products[i].type === s)
            arr.push(Products[i]);
    }
    return arr;
}

// Xử lý slider chuyển động
var slides = document.querySelectorAll('.slide__box');
var i = 1;
setInterval(function() {
    slides.forEach(function(slide) {
        slide.style.display = 'none';
    });
    if (slides[i]) {
        slides[i].style.display = 'block';
    }
    i++;
    if (i == 4) {
        i = 0;
    }
}, 4000);

// Trả về vị trí trong mảng của KH đang đăng nhập
function returnCurIndex() {
    var arr = localStorage.getItem("account") ? JSON.parse(localStorage.getItem("account")) : accounts;

    for(let i=1; i < arr.length; i++) {
        if((arr[0].isAdmin || arr[0].isUser) && (arr[i].Username === arr[0].Username && arr[i].Password === arr[0].Password)) {
            return i;
        }
    }

    return -1;
}

// ** Xử lý thay đổi URL trên sidebar
const productList = document.querySelector('.section__content-list');
const sectionItems = document.querySelectorAll('.section__header-menu li');
const sectionContents = document.querySelectorAll('.section__content');
const sidebarItems = document.querySelectorAll('.sidebar__menu-item');

function sidebarControl() {
    sidebarItems.forEach(function(sidebarItem, index) {
        sidebarItem.onclick = function() {
            document.querySelector('.sidebar__menu-item.active').classList.remove('active');
            sidebarItem.classList.add('active');

            sectionContents.forEach(function(sectionContent) {
                sectionContent.style.display = 'none';
            })

            switch(index) {
                case 0:
                    document.querySelector('.section__content.home').style.display = "block";
                    break;
                case 1:
                    document.querySelector('.section__content.food').style.display = "block";
                    renderProduct(getProducts('bento'));
                    renderProductDefault(getProducts('bento'));
                    break;
                case 2:
                    document.querySelector('.section__content.checkout').style.display = "block";
                    updateCart();
                    break;
                case 3:
                    document.querySelector('.section__contact.section__contact').style.display = "flex";
                    break;
                // case 4:
                //     window.location.pathname = 'admin.html';
                //     break;
            }
        }
    })
    
}

// Render các sp và hiện ra phân trang mặc định ở trang đầu
function renderProductDefault(arrList) {
    pageDefault();
    renderProduct(arrList);
    productHandle(arrList);

    if(arrList.length > 8) {
        pagi.style.display = "flex";
        PagiHandle(arrList);
        renderNumPage();
    }
    else {
        pagi.style.display = "none";
    }
    changeNumPage(arrList);
}

// ** Xử lý render sản phẩm ra màn hình
function renderProduct(items) {
    const htmls = items.map((item, index) => {
        if(index >= start1 && index < end) {
            return `
                <li class="section__content-item">
                    <div class="section__content-item-img" style="background-image: url('${splitImg(item.image)}');"></div>
                    <div class="section__content-item-text">
                        <h3>${item.name}</h3>
                        <p>${item.price} ₫</p>
                    </div>
                    <i class="eye-icon ti-eye" style="display: none;"></i>
                </li>`
        }
    });

    productList.innerHTML = htmls.join('');
}

// ** Xử lý di chuột qua các sản phẩm trong danh sách
const overlay = document.querySelector('.overlay.detail');
const modal = document.querySelector('.modal');

function productHandle(arrList) {
    var productItems = document.querySelectorAll('.section__content-item');
    var sectionImages = document.querySelectorAll('.section__content-item-img');
    var closeDetail = document.querySelector('.modal > i.close-icon');

    var details = document.querySelectorAll('.eye-icon');
    
    productItems.forEach((item, index) => {
        sectionImages[index].style.transition = 'all linear 0.3s'; // cho các hành động mượt hơn
        item.onmouseover = function() {
            sectionImages[index].style.backgroundSize = '110%'; // Zoom to nhỏ hình ảnh sản phẩm
            details[index].style.display = 'block'; // Ẩn hiện con mắt
        }
        item.onmouseout = function() {
            sectionImages[index].style.backgroundSize = '100%';
            details[index].style.display = 'none';
        }

        details[index].onclick = function() {
            document.querySelector('.modal__inner-img').style.backgroundImage = `url(${splitImg(arrList[index + perPage * (curPage - 1)].image)})`;
            document.querySelector('.modal__inner-heading').innerText = arrList[index + perPage * (curPage - 1)].name;
            document.querySelector('.modal__inner-price').innerText = arrList[index + perPage * (curPage - 1)].price;
            overlay.classList.add('open');
        }

        overlay.onclick = function() {
            quantity.value = 1;
            sizeProduct.value = 'S';
            overlay.classList.remove('open');
            cartNotify.style.transform = 'translateX(100%)';
            cartNotify.style.opacity = '0';
        }

        closeDetail.onclick = function() {
            quantity.value = 1;
            sizeProduct.value = 'S';
            overlay.classList.remove('open');
            cartNotify.style.transform = 'translateX(100%)';
            cartNotify.style.opacity = '0';
        }

        modal.onclick = function(e) {
            e.stopPropagation();
        }
    })
}

// ** Điều khiển nút bấm trên Section
function sectionControl(list) {
    list.forEach((item, index) => {
        item.onclick = function() {
            var arrList = [];
            
            document.querySelector('.section__header-menu li.active').classList.remove('active')
            item.classList.add('active')

            arrList = getProducts(typeList[index])
            
            renderProductDefault(arrList)
        }
    })
    
}

// ** Xử lý phân trang
var perPage = 8; // Số sản phẩm tối đa trong 1 trang
var curPage = 1; // Trang hiện tại 
var start1 = 0; // index sản phẩm đầu
var end = perPage; // index sản phẩm cuối
var totalPage;

const btnNext = document.querySelector('.btn-next');
const btnPrev = document.querySelector('.btn-prev');
const pagi = document.getElementById('pagination');
const pageNum = document.querySelector('.pagi-number-page');
// Lấy ra trang hiện tại
function getCurrentPage(curPage) {
    start1 = (curPage - 1) * perPage;
    end = curPage * perPage;
}

function PagiHandle(arrList) {
    totalPage = Math.ceil(arrList.length / perPage); // Tổng số trang của 1 loại sp
    // Ấn next tới trang tiếp theo
    btnNext.onclick = function() {
        curPage++;
        if(curPage >= totalPage) {
            curPage = totalPage;
            btnNext.classList.remove('active');
            btnPrev.classList.add('active');
        }
        else {
            btnNext.classList.add('active');
            btnPrev.classList.add('active');
        }
        document.querySelector('.pagi-number-page li.active').classList.remove('active');
        document.querySelectorAll('.pagi-number-page li')[curPage - 1].classList.add('active');
        
        getCurrentPage(curPage);
        renderProduct(arrList);
        productHandle(arrList);
    }
    // Ấn prev tới trang trước đó
    btnPrev.onclick = function() {
        curPage--;
        if(curPage <= 1) {
            curPage = 1 ;
            btnNext.classList.add('active');
            btnPrev.classList.remove('active');
        }
        else {
            btnNext.classList.add('active');
            btnPrev.classList.add('active');
        }
        document.querySelector('.pagi-number-page li.active').classList.remove('active');
        document.querySelectorAll('.pagi-number-page li')[curPage - 1].classList.add('active');

        getCurrentPage(curPage);
        renderProduct(arrList);
        productHandle(arrList);
    }
}

// Xử lý hiện số trang ra màn hình
function renderNumPage() {
    var html = '';
    html += `<li class="active">${1}</li>`;

    for(let i=2; i <= totalPage; i++) {
        html += `
        <li>${i}</li>`;
    }
    pageNum.innerHTML = html;
}

// Xử lý thay đổi số trang
function changeNumPage(arrList) {
    var numPages = document.querySelectorAll('.pagi-number-page li');

    for(let i=0; i < numPages.length; i++) {
        numPages[i].onclick = function() {
            document.querySelector('.pagi-number-page li.active').classList.remove('active');
            numPages[i].classList.add('active');

            if(i == 0) {
                btnNext.classList.add('active');
                btnPrev.classList.remove('active');
            }
            else if(i == numPages.length - 1) {
                btnNext.classList.remove('active');
                btnPrev.classList.add('active');
            }
            else {
                btnNext.classList.add('active');
                btnPrev.classList.add('active');
            }

            let value = i + 1;
            curPage = value;
            getCurrentPage(curPage);
            renderProduct(arrList);
            productHandle(arrList);
        }
    }
}

// Trang mặc định ban đầu
function pageDefault() {
    getCurrentPage(1);
    curPage = 1;
    btnNext.classList.add('active');
    btnPrev.classList.remove('active');
}

// ** Xử lý ẩn/hiện form Đăng ký/Đăng nhập
const loginBtn = document.querySelector('#section__header-login:not(.section__login)');
const overlayLogin = document.querySelector('.overlay.login');
const modalLogin = document.querySelector('.modal.login');
const closeLogin = document.querySelectorAll('.close-icon.login');
const signupBtn = document.querySelector('.wrapper__not-account span');
const formSignup = document.querySelector('.sign-up');
const formSignin = document.querySelector('.sign-in');
const loginBack = document.querySelector('.login-back-icon');
const inputFrom = document.querySelectorAll('.wrapper__form input');

function openFormLogin() {
    var arr = localStorage.getItem('account') ? JSON.parse(localStorage.getItem('account')) : accounts;
    if(arr[0].isAdmin == false && arr[0].isUser == false) {
        formSignup.style.display = 'none';
        formSignin.style.display = 'block';
        overlayLogin.classList.add('open');
    }
}

function closeFormLogin() {
    for(let i = 0; i < closeLogin.length; i++) {
        closeLogin[i].onclick = function() {
            overlayLogin.classList.remove('open');
        }
    }
    overlayLogin.onclick = function() {
        overlayLogin.classList.remove('open');
    }
    
    modalLogin.onclick = function(e) {
        e.stopPropagation();
    }
}

signupBtn.onclick = function() {
    formSignup.style.display = 'block';
    formSignin.style.display = 'none';
}

loginBack.onclick = function() {
    formSignup.style.display = 'none';
    formSignin.style.display = 'block';
}

closeFormLogin();

// ** Xử lý lưu dữ liệu trên form Đăng ký/Đăng nhập
const loginFullname = document.getElementById('fullname');
const loginUsername = document.getElementById('username');
const loginpassword = document.getElementById('password');
const loginAgainPassword = document.getElementById('again-password');
const loginEmail = document.getElementById('email');
const loginPhone = document.getElementById('phone');
const loginAddress = document.getElementById('address');
const loginNote = document.getElementById('mytextarea');
const overlayNotify = document.querySelector('.overlay-notify');

var accounts = [
    {
        isAdmin: false,
        isUser: false,
        isLogout: true,
        Fullname: 'user',
        Username: 'user',
        Password: 'user'
    },
    {
        Fullname: 'Admin',
        Password: 'admin',
        Username: 'admin',
        email: 'admin@gmail.com',
        ngaydangky: '27-11-2022',
        cart: [],
        donhang: []
    }
]

// Set mặc định cho arr (account)
const arr = localStorage.getItem('account') ? JSON.parse(localStorage.getItem('account')) : accounts;

if(arr === accounts) {
    localStorage.setItem("account", JSON.stringify(accounts))
}

loginFullname.onblur = function() {
    var fullname = loginFullname.value;
    checkFullname(fullname, 2);
}

loginUsername.onblur = function() {
    var username = loginUsername.value;
    checkUsername(username, 3);
}

loginpassword.addEventListener('blur', function() {
    var password = loginpassword.value;
    checkPassword(password, 4);
})

loginAgainPassword.addEventListener('blur', function() {
    var againPassword = loginAgainPassword.value;
    var password = loginpassword.value;
    checkAgainPassword(password, againPassword, 5);
})

loginEmail.addEventListener('blur', function() {
    var email = loginEmail.value;
    checkEmail(email, 6);
})

loginPhone.addEventListener('blur', function() {
    var phone = loginPhone.value;
    checkPhone(phone, 7);
})

loginAddress.addEventListener('blur', function() {
    var address = loginAddress.value;
    checkAddress(address, 8);
})

document.getElementById('Username').onblur = function() {
    var username = document.getElementById('Username').value;
    checkUsername(username, 0);
}

document.getElementById('Password').onblur = function() {
    var password = document.getElementById('Password').value;
    checkPassword(password, 1);
}

function addLogin() {
    var fullname = loginFullname.value;
    var username = loginUsername.value;
    var password = loginpassword.value;

    var arr = localStorage.getItem('account') ? JSON.parse(localStorage.getItem('account')) : accounts;
    var User = {
        Fullname: fullname,
        Password: password,
        Username: username,
        ngaydangky: getCurDate(),
        email: '',
        cart: [],
        donhang: []
    }
    arr.push(User);
    localStorage.setItem('account', JSON.stringify(arr));
    clear();
}

// ** Check lỗi Form
var isFullname = false;
var isUsername = false;
var isPassword = false;
var isAgainPassword = false;
var isEmail = false
var isPhone = false;
var isAddress = false;
var errorMessage = document.querySelectorAll('.error-message');

function hasWhiteSpace(s) {
    return s.indexOf(' ') >= 0;
}

function checkFullname(fullname, index) {
    if(fullname === '' || fullname === null) {
        errorMessage[index].innerHTML = `<i class="fa-solid fa-circle-exclamation"></i>
                                        Họ tên không được để trống`
        errorMessage[index].style.opacity = '1';
        isFullname = false;
    }
    else if(fullname.length > 30) {
        errorMessage[index].innerHTML = `<i class="fa-solid fa-circle-exclamation"></i>
                                        Họ tên từ 1-30 ký tự`
        errorMessage[index].style.opacity = '1';
        isFullname = false;
    }
    else {
        isFullname = true;
        errorMessage[index].style.opacity = '0';
    }
}

function checkUsername(username, index) {
    var arr = localStorage.getItem('account') ? JSON.parse(localStorage.getItem('account')) : accounts;
    for(let i=0; i < arr.length; i++) {
        if(username === '' || username === null) {
            errorMessage[index].innerHTML = `<i class="fa-solid fa-circle-exclamation"></i>
                                            Tên đăng nhập không được để trống`
            errorMessage[index].style.opacity = '1';
            isUsername = false;
        }
        else if(username.length < 5) {
            errorMessage[index].innerHTML = `<i class="fa-solid fa-circle-exclamation"></i>
                                            Tên đăng nhập có ít nhất 5 ký tự`
            errorMessage[index].style.opacity = '1';
            isUsername = false;
        }
        else if(arr[i].Username === username && index != 0) {
            errorMessage[index].innerHTML = `<i class="fa-solid fa-circle-exclamation"></i>
                                            Tên đăng nhập bị trùng, vui lòng nhập tên khác`
            errorMessage[index].style.opacity = '1';
            isUsername = false;
        }
        else {
            isUsername = true;
            errorMessage[index].style.opacity = '0';
        }
    }
}

function checkPassword(password, index) {
    if(password === '' || password === null) {
        errorMessage[index].innerHTML = `<i class="fa-solid fa-circle-exclamation"></i>
                                        Mật khẩu không được để trống`
        errorMessage[index].style.opacity = '1';
        isPassword = false;
    }
    else if(password.length < 8 && password !== 'admin') {
        errorMessage[index].innerHTML = `<i class="fa-solid fa-circle-exclamation"></i>
                                        Mật khẩu có ít nhất 8 ký tự`;
        errorMessage[index].style.opacity = '1';
        isPassword = false;
    }
    else {
        isPassword = true;
        errorMessage[index].style.opacity = '0';
    }
}

function checkAgainPassword(password, againPassword, index) {
    if(againPassword === '' || againPassword === null) {
        errorMessage[index].innerHTML = `<i class="fa-solid fa-circle-exclamation"></i>
                                        Mật khẩu không được để trống`
        errorMessage[index].style.opacity = '1';
        isAgainPassword = false;
    }
    else if(password !== againPassword) {
        errorMessage[index].innerHTML = `<i class="fa-solid fa-circle-exclamation"></i>
                                        Mật khẩu nhập lại không đúng`;
        errorMessage[index].style.opacity = '1';
        isAgainPassword = false;
    }
    else {
        isAgainPassword = true;
        errorMessage[index].style.opacity = '0';
    }
}

function checkEmail(email, index) {
    var regExp = /^([a-zA-Z0-9_\.\-])+\@(([a-zA-Z0-9\-])+\.)+([a-zA-Z0-9]{2,4})+$/;
    if(email === '' || email === null) {
        errorMessage[index].innerHTML = `<i class="fa-solid fa-circle-exclamation"></i>
                                        Email không được để trống`
        errorMessage[index].style.opacity = '1';
        isEmail = false;
    }
    else if(!regExp.test(email)) {
        errorMessage[index].innerHTML = `<i class="fa-solid fa-circle-exclamation"></i>
                                        Hãy nhập email hợp lệ. (example@gmail.com)`
        errorMessage[index].style.opacity = '1';
        isEmail = false;
    }
    else {
        isEmail = true;
        errorMessage[index].style.opacity = '0';
    }
}

function checkPhone(phone, index) {
    var regExp = /((09|03|07|08|05)+([0-9]{8})\b)/g;
    if(phone === '' || phone === null) {
        errorMessage[index].innerHTML = `<i class="fa-solid fa-circle-exclamation"></i>
                                        SĐT không được để trống`
        errorMessage[index].style.opacity = '1';
        isPhone = false;
    }
    else if(hasWhiteSpace(phone)) {
        errorMessage[index].innerHTML = `<i class="fa-solid fa-circle-exclamation"></i>
                                        SĐT không được chứa khoảng trắng`
        errorMessage[index].style.opacity = '1';
        isPhone = false;
    }
    else if(!regExp.test(phone)) {
        errorMessage[index].innerHTML = `<i class="fa-solid fa-circle-exclamation"></i>
                                        Hãy nhập sđt hợp lệ. (07xxxxxxxx)`
        errorMessage[index].style.opacity = '1';
        isPhone = false;
    }
    else {
        isPhone = true;
        errorMessage[index].style.opacity = '0';
    }
}

function checkAddress(address, index) {
    if(address === '' || address === null) {
        errorMessage[index].innerHTML = `<i class="fa-solid fa-circle-exclamation"></i>
                                        Địa chỉ không được để trống`
        errorMessage[index].style.opacity = '1';
        isAddress = false;
    }
    else {
        isAddress = true;
        errorMessage[index].style.opacity = '0';
    }
}

// Kiểm tra đăng nhập Người dùng bình thường
function checkSignin() {
    var Username = document.getElementById('Username').value;
    var Password = document.getElementById('Password').value;
    var arr = localStorage.getItem('account') ? JSON.parse(localStorage.getItem('account')) : accounts;
    for(let i = 1; i < arr.length; i++) {
        if(arr[i].Username === Username && arr[i].Password === Password) {
            arr[0].Fullname = arr[i].Fullname;
            arr[0].Username = arr[i].Username;
            arr[0].Password = arr[i].Password;
            localStorage.setItem('account', JSON.stringify(arr));
            return true;
        }
    }

    return false;
}

// Kiểm tra nhấn Enter vào form đk, đn
document.getElementById('Password').addEventListener('keydown', function(e) {
    if(e.key == 'Enter' || e.which == 13) {
        btnSignin();
    }
})

document.getElementById('again-password').addEventListener('keydown', function(e) {
    if(e.key == 'Enter' || e.which == 13) {
        btnSignup();
    }
})

// Kiểm tra đăng nhập Người dùng là Admin
function checkAdmin() {
    var Username = document.getElementById('Username').value;
    var Password = document.getElementById('Password').value;
    var arr = localStorage.getItem('account') ? JSON.parse(localStorage.getItem('account')) : accounts;
    for(let i = 1; i < arr.length; i++) {
        if (Username == "admin" && Password == "admin" && arr[i].Username === Username && arr[i].Password === Password) {
            return true;
        }
    }

    return false;
}

function clear() {
    loginFullname.value = "";
    loginUsername.value = "";
    loginpassword.value = "";
    loginAgainPassword.value = "";
}

function btnSignup() {
    var fullname = loginFullname.value;
    checkFullname(fullname, 2);
    var username = loginUsername.value;
    checkUsername(username, 3);
    var password = loginpassword.value;
    checkPassword(password, 4);
    var againPassword = loginAgainPassword.value;
    checkAgainPassword(password, againPassword, 5);
    if(isFullname === true && isUsername === true && isPassword === true && isAgainPassword === true) {
        setTimeout(function() {
            addLogin();
            overlayNotify.style.transform = 'translateX(0)';
            overlayNotify.style.opacity = '1';
            overlayNotify.innerHTML = `<div class="login-notify success">
                                            <i class="fa-solid fa-circle-check"></i>
                                            Đăng ký thành công
                                        </div>`;
        }, 500)
        
        setTimeout(function() {
            overlayNotify.style.transform = 'translateX(100%)';
            overlayNotify.style.opacity = '0';
            formSignup.style.display = 'none';
            formSignin.style.display = 'block';
        }, 2000)
    }
    else {
        setTimeout(function() {
            overlayNotify.style.transform = 'translateX(0)';
            overlayNotify.style.opacity = '1';
            overlayNotify.innerHTML = `<div class="login-notify error">
                                        <i class="fa-solid fa-circle-xmark"></i>
                                        Đăng ký chưa hợp lệ!!
                                    </div>`;
        }, 500)

        setTimeout(function() {
            overlayNotify.style.transform = 'translateX(100%)';
            overlayNotify.style.opacity = '0';
        }, 2000)
    }
}

document.getElementById('login-btn').onclick = function(e) {
    btnSignup();
}

function btnSignin() {
    var arr = localStorage.getItem('account') ? JSON.parse(localStorage.getItem('account')) : accounts;
    if(checkAdmin()) {
        arr[0].isAdmin = true;
        arr[0].isUser = false;
        arr[0].isLogout = false;
        arr[0].Fullname = arr[1].Fullname;
        arr[0].Username = arr[1].Username;
        arr[0].Password = arr[1].Password;

        setTimeout(function() {
            overlayNotify.style.transform = 'translateX(0)';
            overlayNotify.style.opacity = '1';
            overlayNotify.innerHTML = `<div class="login-notify success">
                                        <i class="fa-solid fa-circle-check"></i>
                                        Đăng nhập thành công
                                    </div>`;
            checkAccount();
            getNoProductCart();
        }, 500)

        setTimeout(function() {
            overlayNotify.style.transform = 'translateX(100%)';
            overlayNotify.style.opacity = '0';
            overlayLogin.classList.remove('open');
        }, 2000)

        // setTimeout(function() {
        //     window.location.href = 'index.html';
        // }, 2300)

    }
    else if(checkSignin()) {
        arr[0].isUser = true;
        arr[0].isAdmin = false;
        arr[0].isLogout = false;
              
        setTimeout(function() {
            overlayNotify.style.transform = 'translateX(0)';
            overlayNotify.style.opacity = '1';
            overlayNotify.innerHTML = `<div class="login-notify success">
                                        <i class="fa-solid fa-circle-check"></i>
                                        Đăng nhập thành công
                                    </div>`;
            checkSignin();
            checkAccount();
            getNoProductCart();
        }, 500)

        setTimeout(function() {
            overlayNotify.style.transform = 'translateX(100%)';
            overlayNotify.style.opacity = '0';
            overlayLogin.classList.remove('open');
        }, 2000)
    }
    else {
        setTimeout(function() {
            overlayNotify.style.transform = 'translateX(0)';
            overlayNotify.style.opacity = '1';
            overlayNotify.innerHTML = `<div class="login-notify error">
                                        <i class="fa-solid fa-circle-xmark"></i>
                                        Đăng nhập thất bại!!
                                    </div>`;
        }, 500)

        setTimeout(function() {
            overlayNotify.style.transform = 'translateX(100%)';
            overlayNotify.style.opacity = '0';
        }, 2000)
        document.getElementById('Username').value = "";
        document.getElementById('Password').value = "";
    }

    localStorage.setItem('account',JSON.stringify(arr))

}

document.getElementById('Login-Btn').onclick = function() {
    btnSignin();
    getNoProductCart();
}

// Kiểm tra tài khoản đã có hay chưa
function checkAccount() {
    var arr = localStorage.getItem('account') ? JSON.parse(localStorage.getItem('account')) : accounts;

    if(arr[0].isAdmin != false || arr[0].isUser != false) {
        if(arr[0].isAdmin == true) {
            document.querySelector('.sidebar__menu-item:last-child').classList.remove('hide');
            document.querySelector('.section__header-title-text.login').innerText = arr[0].Fullname;
        }
        else if(arr[0].isUser == true) {
            document.querySelector('.section__header-title-text.login').innerText = arr[0].Fullname;
        }

        document.querySelector('.sidebar__log-out').classList.remove('hide');
    }

    localStorage.setItem('account',JSON.stringify(arr));
}

// Xử lý khi ấn vào nút Log out
const logout = document.querySelector('.sidebar__log-out');
const notify = document.querySelector('.notify'); 

function btnLogout() {
    var arr = localStorage.getItem('account') ? JSON.parse(localStorage.getItem('account')) : accounts;

    if(arr[0].isAdmin == true) {
        document.querySelector('.sidebar__menu-item:last-child').classList.add('hide');
    }

    arr[0].isLogout = true;
    arr[0].isAdmin = false;
    arr[0].isUser = false;
    arr[0].Fullname = 'user';
    arr[0].Username = 'user';
    arr[0].Password = 'user';
    document.getElementById('Username').value = "";
    document.getElementById('Password').value = "";

    setTimeout(function() {
        notify.style.transform = 'translateX(0)';
        notify.style.opacity = '1';
        notify.innerHTML = `<div class="inner-notify success">
                                <i class="fa-solid fa-person-running"></i>
                                Đăng xuất thành công
                            </div>`;
    }, 500)
    
    setTimeout(function() {
        notify.style.transform = 'translateX(100%)';
        notify.style.opacity = '0';
    }, 1300)

    document.querySelector('.section__header-title-text.login').innerHTML = 'Đăng nhập';
    document.querySelector('.sidebar__log-out').classList.add('hide');
    localStorage.setItem('account',JSON.stringify(arr));
}

logout.onclick = function() {
    btnLogout();
    getNoProductCart();
}

// ** Xử lý cuộn lên trang đầu
const scrollToTop = document.getElementById('scroll-to-top');

function scrollTopHandle() {
    window.onscroll = function() {
        // Kiểm tra vị trí hiện tại của con trỏ so với nội dung trang
        if (document.body.scrollTop > 200 || document.documentElement.scrollTop > 200) {
            //nếu lớn hơn 200px thì hiện button
            scrollToTop.style.display = "block";
        }
        else {
            //nếu nhỏ hơn 200px thì ẩn button
            scrollToTop.style.display = "none";
        }
    };
    //gán sự kiện click cho button
    scrollToTop.addEventListener("click", function(){
        //Nếu button được click thì nhảy về đầu trang
        document.body.scrollTop = 0;
        document.documentElement.scrollTop = 0;
    });
}

// ** Xử lý tăng giảm số lượng
const amountBtns = document.querySelectorAll(".modal__inner-amount input[type='button']");
var quantity = document.querySelector(".modal__inner-amount input[type='text']");
var sizeProduct = document.querySelector('.modal__inner-size select');

amountBtns.forEach((amountBtn, index) => {
    amountBtn.onclick = function() {
        if(index == 0) {
            if(quantity.value == 1) {
                quantity.value = 1;
            }
            else {
                quantity.value--;
            }
        }
        else {
            quantity.value++;
        }
    }
})

// ** Tìm kiếm sản phẩm
var sectionMenu = document.querySelector('.section__header-menu');
var sectionTitle = document.querySelector('.section__content-title');
var sectionSearch = document.getElementById('section__search');

// Xử lý xóa tìm kiếm
function deleteSearchHandle() {
    sectionSearch.value = '';
    sectionMenu.style.display = 'flex';
    sectionTitle.style.display = 'flex';
    renderProduct(getProducts('bento'));
    renderProductDefault(getProducts('bento'));
}

var deleteSearch = document.querySelector('.section__delete');
deleteSearch.addEventListener('click', function() {
    deleteSearchHandle();
    deleteSearch.style.display = 'none';
})

sectionSearch.oninput = function() {
    if(sectionSearch.value === '') {
        deleteSearch.style.display = 'none';
        deleteSearchHandle();
    }
}

// Xử lý tìm kiếm
var isFilter = false;

function searchProduct() {
    switchToFood();
    const x = sectionSearch.value.toLowerCase();
    if (x != '') {
        sectionMenu.style.display = 'none';
        sectionTitle.style.display = 'none';
        deleteSearch.style.display = 'none';
    } else {
        sectionMenu.style.display = 'flex';
        sectionTitle.style.display = 'flex';
        deleteSearch.style.display = 'block';
    }

    const arrProducts = [];

    if (x.length > 0) {
        deleteSearch.style.display = 'block';
    }
    else {
        deleteSearch.style.display = 'none';
    }

    for (let i = 0; i < Products.length; i++) {
        if (Products[i].name.toLowerCase().includes(x) == true) {
            arrProducts.push(Products[i]);
        }
    }

    renderProductDefault(arrProducts);

    if (arrProducts.length === 0 || x == '') {
        document.querySelector('.section__content-list').innerHTML = `<h1 class="search__notfound">
        <img src="../images/no-products-found.png" alt="">
        <p>Không tìm thấy sản phẩm nào</p></h1>`
    }
}

function switchToFood() {
    document.querySelector('.sidebar__menu-item.active').classList.remove('active');
    sidebarItems[1].classList.add('active');

    sectionContents.forEach(function(sectionContent) {
        sectionContent.style.display = 'none';
    })

    document.querySelector('.section__content.food').style.display = "block";
    updateCart();
}

sectionSearch.addEventListener('keydown', function(e) {
    if(e.key == 'Enter' || e.which == 13) {
        searchProduct();
    }
})

// Xử lý bộ lọc tìm kiếm
const filterBtn = document.getElementById('filter-btn');
filterBtn.addEventListener('click', function() {
    if(!isFilter) {
        isFilter = true;
        document.querySelector('.filter').style.display = "flex";
        document.querySelector('.filter').style.opacity = "1";
    }
    else {
        isFilter = false;
        document.querySelector('.filter').style.display = "none";
        document.querySelector('.filter').style.opacity = "0";
        renderProduct(getProducts('bento'));
        renderProductDefault(getProducts('bento'));
    }
})

if(!isFilter) {
    document.querySelector('.filter').style.display = "none";
    document.querySelector('.filter').style.opacity = "0";
}

const typeProduct = document.querySelectorAll('.filter__header-selectors li');

function typeProductHandle() {
    for(let i = 0; i < typeProduct.length; i++) {
        typeProduct[i].onclick = function() {
            var flag = -1;
            
            if(document.querySelector('.filter__header-selectors li.active') != null) {
                if(typeProduct[i].innerText === document.querySelector('.filter__header-selectors li.active').innerText) {
                    flag = i;
                }
                document.querySelector('.filter__header-selectors li.active').classList.remove('active');
            }
            
            typeProduct[i].classList.add('active');

            if(flag != -1) {
                document.querySelector('.filter__header-selectors li.active').classList.remove('active');
            }
        }
    }
}

typeProductHandle();

function filterHandle() {
    var nameProduct = document.getElementById('nameproduct').value.toLowerCase();
    var moneyMin = document.getElementById('moneymin').value;
    var moneyMax = document.getElementById('moneymax').value;
    moneyMin = parseInt(moneyMin);
    moneyMax = parseInt(moneyMax);

    if (((!isNaN(moneyMin) && !isNaN(moneyMax)) && (moneyMin > moneyMax)) || (isNaN(moneyMin) && !isNaN(moneyMax)) || (!isNaN(moneyMin) && isNaN(moneyMax))) {
        setTimeout(function() {
            notify.style.transform = 'translateX(0)';
            notify.style.opacity = '1';
            notify.innerHTML = `<div class="login-notify error">
                                        <i class="fa-solid fa-circle-xmark"></i>
                                        Khoảng giá không hợp lệ
                                    </div>`;
        }, 300)
        document.getElementById('moneymin').value = '';
        document.getElementById('moneymax').value = '';
        setTimeout(function() {
            notify.style.transform = 'translateX(100%)';
            notify.style.opacity = '0';
            return;
        }, 1500)
    }

    var arrtemp1;
    var arrtemp2 = [];
    var arrtemp3 = [];

    const typeProductActive = document.querySelector('.filter__header-selectors li.active')
    for(let i=0; i < typeList.length; i++) {
        if(typeProductActive != null) {
            if(typeProduct[i].innerText === typeProductActive.innerText) {
                arrtemp1 = getProducts(typeList[i]).slice();
            }
        }
    }

    if(arrtemp1 === undefined) {
        arrtemp1 = [];
    }

    for (let i = 0; i < Products.length; i++) {
        if(nameProduct !== '' && nameProduct !== null && Products[i].name.toLowerCase().includes(nameProduct)) {
            arrtemp2.push(Products[i]);
            console.log(nameProduct)
        }
        
        var temp = Products[i].price;
        var money = parseInt(Products[i].price.split(','));
        if(moneyMin !== NaN && moneyMax !== NaN && (money >= moneyMin && money <= moneyMax)) {
            Products[i].price = temp;
            arrtemp3.push(Products[i]);
        }
        
    }

    var arrtemp = [];

    if((arrtemp1.length > 0 && arrtemp2.length === 0 && arrtemp3.length === 0) || 
        (arrtemp2.length > 0 && arrtemp1.length === 0 && arrtemp3.length === 0) ||
        (arrtemp3.length > 0 && arrtemp1.length === 0 && arrtemp2.length === 0)) {
            arrtemp = [...arrtemp1, ...arrtemp2, ...arrtemp3];
    }
    else {
        if(arrtemp1.length > 0 && arrtemp2.length > 0 && arrtemp3.length > 0) {
            var test = [];
            var a = [];
            test = [...arrtemp1, ...arrtemp2].filter(function(item) {
                return test.includes(item) ? a.push(item) : test.push(item);
            })
        
            var test_2 = []
            test_2 = [...a, ...arrtemp3].filter(function(item) {
                return test_2.includes(item) ? arrtemp.push(item) : test_2.push(item);
            })
        }
        else {
            if(arrtemp1.length > 0 && arrtemp2.length > 0 && arrtemp3.length === 0) {
                var test = [];
                test = [...arrtemp1, ...arrtemp2].filter(function(item) {
                    return test.includes(item) ? arrtemp.push(item) : test.push(item);
                })
            }
            if(arrtemp1.length > 0 && arrtemp3.length > 0 && arrtemp2.length === 0) {
                var test = [];
                test = [...arrtemp1, ...arrtemp3].filter(function(item) {
                    return test.includes(item) ? arrtemp.push(item) : test.push(item);
                })
            }
            if(arrtemp2.length > 0 && arrtemp3.length > 0 && arrtemp1.length === 0) {
                var test = [];
                test = [...arrtemp2, ...arrtemp3].filter(function(item) {
                    return test.includes(item) ? arrtemp.push(item) : test.push(item);
                })                
            }
        }
    }
    
    renderProductDefault(arrtemp)

    if (arrtemp.length === 0) {
        document.querySelector('.section__content-list').innerHTML = `<h1 class="search__notfound">
        <img src="../images/no-products-found.png" alt="">
        <p>Không tìm thấy sản phẩm nào</p></h1>`
    }
}

// ** Xử lý giỏ hàng
const pay = document.getElementById('pay');
const overlayCart = document.querySelector('.overlay.cart-info');
const closeCart = document.querySelector('.close-icon.cart');
const modalCart = document.querySelector('.modal.checkout__info');
const confirmBtn = document.getElementById('confirm-btn');

// Xử lý khi ấn vào xem giỏ hàng
document.querySelector('.section__notify-footer-tocart').onclick = function() {
    document.querySelector('.sidebar__menu-item.active').classList.remove('active');
    sidebarItems[2].classList.add('active');

    sectionContents.forEach(function(sectionContent) {
        sectionContent.style.display = 'none';
    })

    document.querySelector('.section__content.checkout').style.display = "block";
    updateCart();
}

// Xử lý khi ấn vào thanh toán
pay.addEventListener('click', function() {
    var arr = localStorage.getItem("account") ? JSON.parse(localStorage.getItem("account")) : accounts;
    if(returnCurIndex() != -1) {
        overlayCart.classList.add('open');

        loginEmail.value = arr[returnCurIndex()].email;

        if(arr[returnCurIndex()].cart.length > 0) {
            confirmBtn.addEventListener('click', function() {
                thongTinDonHang(returnCurIndex());
            })
        }
    }
    else {
        notify.style.transform = 'translateX(0)';
        notify.style.opacity = '1';
        notify.innerHTML = `<div class='notify__confirm'>
                                    <div class="notify__confirm-text">
                                        Bạn cần đăng nhập để mua hàng !
                                    </div>
                                    <div class="notify__confirm-btn">
                                        <div class="notify__confirm-ok">
                                            OK
                                        </div>
                                        <div class="notify__confirm-cancel">
                                            Hủy
                                        </div>
                                    </div>
                                </div>`;

        document.querySelector('.notify__confirm').onclick = function(e) {
            e.stopPropagation();
        }

        document.querySelector('.notify__confirm-ok').onclick = function() {
                notify.style.transform = 'translateX(100%)';
                notify.style.opacity = '0';
                openFormLogin();
            }
            document.querySelector('.notify__confirm-cancel').onclick = function() {
                notify.style.transform = 'translateX(100%)';
                notify.style.opacity = '0';
            }
    }
})

closeCart.onclick = function() {
    overlayCart.classList.remove('open');
}

overlayCart.onclick = function() {
    overlayCart.classList.remove('open');
}

modalCart.onclick = function(e) {
    e.stopPropagation();
}

// Form thông tin đơn hàng
function thongTinDonHang(i) {
    var arr = localStorage.getItem("account") ? JSON.parse(localStorage.getItem("account")) : accounts;

    var email = loginEmail.value;
    var phone = loginPhone.value;
    var address = loginAddress.value;
    var note = loginNote.value;

    var soluong = document.getElementById('checkout__cart-total-amount').innerText; 
    var tongtien = document.getElementById('checkout__cart-total-money').innerText;

    checkEmail(email, 6);
    checkPhone(phone, 7);
    checkAddress(address, 8);

    if(isEmail && isPhone && isAddress) {
        arr[i].email = email;

        arr[i].donhang.push(
            {
                trangthai: 'Chưa xử lý',
                ngaymua: getCurDate().toString(),
                soluong: soluong,
                tongtien: tongtien,
                phone: phone,
                address: address,
                ghichu: note,
                sanpham: arr[i].cart
            }
        )

        setTimeout(function() {
            notify.style.transform = 'translateX(0)';
            notify.style.opacity = '1';
            notify.innerHTML = `<div class="login-notify success">
                                    <i class="fa-sharp fa-solid fa-circle-check"></i>
                                    Xác nhận thành công
                                </div>`;
        }, 300)
    
        setTimeout(function() {
            notify.style.transform = 'translateX(100%)';
            notify.style.opacity = '0';
        }, 1500)

        setTimeout(function() {
            overlayCart.classList.remove('open');
            // Reset lại thành rỗng
            loginPhone.value = '';
            loginAddress.value = '';
            loginNote.value = '';

            // Xóa các sp khỏi giỏ hàng
            deleteAllCart();
            updateCart();
        }, 1700)
    }
    else {
        setTimeout(function() {
            notify.style.transform = 'translateX(0)';
            notify.style.opacity = '1';
            notify.innerHTML = `<div class="login-notify error">
                                    <i class="fa-solid fa-triangle-exclamation"></i>
                                    Xác nhận thất bại !!
                                </div>`;
        }, 300)
    
        setTimeout(function() {
            notify.style.transform = 'translateX(100%)';
            notify.style.opacity = '0';
        }, 1500) 
    }

    getNoProductCart()
    localStorage.setItem("account", JSON.stringify(arr));
    updateCart()
}

// Thêm vào giỏ hàng
var addCart = document.querySelector(".modal__inner-add-cart");
const cartNotify = document.querySelector('.cart-notify');

addCart.onclick = () => {
    var arr = localStorage.getItem("account") ? JSON.parse(localStorage.getItem("account")) : accounts;
    if(returnCurIndex() != -1) {
        var list = arr[returnCurIndex()].cart;
        var added = false;
        var image = document.querySelector('.modal__inner-img').style.backgroundImage.split('"')[1];
        var name = document.querySelector('.modal__inner-heading').innerText;
        var price = document.querySelector('.modal__inner-price').innerText;
        var size = document.querySelector('.modal__inner-size select').value;
        var amount = parseInt(document.querySelector('.modal__inner-amount input[type="text"]').value)
    
        for(let j=0; j < list.length; j++) {
            if(list[j].image === image && list[j].name === name && list[j].price === price && list[j].size === size) {
                list[j].amount += amount;
                added = true;
            }
        }

        if(!added) {
            var cart = {
                image: image,
                name: name,
                price: price,
                size: size,
                amount: amount
            }
        
            list.push(cart);
        }

        renderCartNotify(list)
        updateCart();
    
        localStorage.setItem("account", JSON.stringify(arr));
    
        setTimeout(function() {
            cartNotify.style.transform = 'translateX(0)';
            cartNotify.style.opacity = '1';
            cartNotify.innerHTML = `<div class="login-notify success">
                                            <i class="fa-solid fa-cart-shopping"></i>
                                            Đã thêm vào giỏ
                                        </div>`;
        }, 300)
    
        setTimeout(function() {
            cartNotify.style.transform = 'translateX(100%)';
            cartNotify.style.opacity = '0';
        }, 1500)

    }
    else {
        cartNotify.style.transform = 'translateX(0)';
        cartNotify.style.opacity = '1';
        cartNotify.innerHTML = `<div class='notify__confirm'>
                                    <div class="notify__confirm-text">
                                        Bạn cần đăng nhập để mua hàng !
                                    </div>
                                    <div class="notify__confirm-btn">
                                        <div class="notify__confirm-ok">
                                            OK
                                        </div>
                                        <div class="notify__confirm-cancel">
                                            Hủy
                                        </div>
                                    </div>
                                </div>`;

        document.querySelector('.notify__confirm').onclick = function(e) {
            e.stopPropagation();
        }

        document.querySelector('.notify__confirm-ok').onclick = function() {
                cartNotify.style.transform = 'translateX(100%)';
                cartNotify.style.opacity = '0';
                openFormLogin();
            }
            document.querySelector('.notify__confirm-cancel').onclick = function() {
                cartNotify.style.transform = 'translateX(100%)';
                cartNotify.style.opacity = '0';
            }
    }

    renderCartNotify(list)
    updateCart()
}

// Xử lý giá sản phẩm
function addComma(number) {
    number = '' + number;
    if (number.length > 3) {
        var mod = number.length % 3;
        var output = (mod > 0 ? (number.substring(0,mod)) : '');
        for (i=0 ; i < Math.floor(number.length / 3); i++) {
            if ((mod == 0) && (i == 0))
                output += number.substring(mod+ 3 * i, mod + 3 * i + 3);
            else
                output+= ',' + number.substring(mod + 3 * i, mod + 3 * i + 3);
        }
        return (output);
    }
    else return number;
}

function deleteComma(s) {
    var arr = s.split(',');
    var money = '';
    for(let i=0; i < arr.length; i++) {
        money += arr[i];
    }

    return parseInt(money);
}

// Hàm lấy ngày tháng hiện tại
function getCurDate() {
    var date = new Date();

    var day = date.getDate();
    var month = date.getMonth() + 1;
    var year = date.getFullYear();
    var s = `${day}-${month}-${year}`;

    return s;
}

function getNoProductCart() {
    var arr = localStorage.getItem('account') ? JSON.parse(localStorage.getItem('account')) : accounts;
    if(returnCurIndex() === -1) {
        document.querySelector('.checkout__cart-products').innerHTML = `<div class="checkout__no-product">
                                                                            Bạn chưa đăng nhập
                                                                        </div>`
        document.getElementById("checkout__cart-total-amount").innerText = '0';
        document.getElementById("checkout__cart-total-money").innerText = '0 ₫';
        document.querySelector('.section__notify-cart-list').innerHTML = `<span>Bạn chưa đăng nhập</span>`;
        document.querySelector('.section__login-list').innerHTML = `<li>Bạn chưa đăng nhập</li>`;
    }
    else if(arr[returnCurIndex()].cart.length === 0) {
        document.querySelector('.checkout__cart-products').innerHTML = `<div class="checkout__no-product">
                                                                            Giỏ hàng trống
                                                                        </div>`
        document.getElementById("checkout__cart-total-amount").innerText = '0';
        document.getElementById("checkout__cart-total-money").innerText = '0 ₫';
        document.querySelector('.section__notify-footer-text').innerText = 'Tổng tiền (0) sản phẩm: ';
        document.querySelector('.section__notify-footer-money').innerText = '0 ₫';
        document.querySelector('.section__notify-cart-list').innerHTML = `<span>Giỏ hàng trống</span>`;
    }
}

getNoProductCart()

function deleteAllCart() {
    var arr = localStorage.getItem("account") ? JSON.parse(localStorage.getItem("account")) : accounts;
    var list = arr[returnCurIndex()].cart
    list.splice(0, list.length);
    renderCartNotify(list)
    localStorage.setItem("account", JSON.stringify(arr));
    updateCart();
}

function initCart() {
    var removeCart = document.querySelectorAll(".product-remove");
    removeCart.forEach((ele) => {
        ele.onclick = () => {
            if(returnCurIndex() != -1) {
                notify.style.transform = 'translateX(0)';
                notify.style.opacity = '1';
                notify.innerHTML = `<div class='notify__confirm'>
                                        <div class="notify__confirm-text">
                                            Bạn xác nhận xóa đơn hàng này?
                                        </div>
                                        <div class="notify__confirm-btn">
                                            <div class="notify__confirm-ok">
                                                OK
                                            </div>
                                            <div class="notify__confirm-cancel">
                                                Hủy
                                            </div>
                                        </div>
                                    </div>`;
        
                document.querySelector('.notify__confirm-ok').onclick = function(e) {
                    notify.style.transform = 'translateX(100%)';
                    notify.style.opacity = '0';
                    var arr = localStorage.getItem("account") ? JSON.parse(localStorage.getItem("account")) : accounts;
                    var list = arr[returnCurIndex()].cart;
    
                    list.splice(e.currentTarget.dataset.index, 1);
                    
                    renderCartNotify(list)
                    localStorage.setItem("account", JSON.stringify(arr));
                    updateCart();
                }
    
                document.querySelector('.notify__confirm-cancel').onclick = function() {
                    notify.style.transform = 'translateX(100%)';
                    notify.style.opacity = '0';
                }
            }
        };
    });

    var removeAll = document.querySelector('.product-remove-all');
    removeAll.onclick = function() {
        if(returnCurIndex() != -1) {
            notify.style.transform = 'translateX(0)';
            notify.style.opacity = '1';
            notify.innerHTML = `<div class='notify__confirm'>
                                    <div class="notify__confirm-text">
                                        Bạn có chắc chắn xóa hết sản phẩm trong giỏ !!
                                    </div>
                                    <div class="notify__confirm-btn">
                                        <div class="notify__confirm-ok">
                                            OK
                                        </div>
                                        <div class="notify__confirm-cancel">
                                            Hủy
                                        </div>
                                    </div>
                                </div>`;
    
            document.querySelector('.notify__confirm-ok').onclick = function() {
                notify.style.transform = 'translateX(100%)';
                notify.style.opacity = '0';
                deleteAllCart()
            }
            document.querySelector('.notify__confirm-cancel').onclick = function() {
                notify.style.transform = 'translateX(100%)';
                notify.style.opacity = '0';
            }
        }
    }
    
    var amountCart = document.querySelectorAll(".checkout__amount");
    amountCart.forEach((ele) => {
        ele.onchange = (e) => {
            if(returnCurIndex() != -1) {
                var arr = localStorage.getItem("account") ? JSON.parse(localStorage.getItem("account")) : accounts;
                var list = arr[returnCurIndex()].cart;
    
                list[e.currentTarget.dataset.index]["amount"] = e.currentTarget.value;
                renderCartNotify(list)
                localStorage.setItem("account", JSON.stringify(arr));
                updateCart();
            }
        };
    });
}

function updateCart() {
    if(returnCurIndex() != -1) {
        var arr = localStorage.getItem("account") ? JSON.parse(localStorage.getItem("account")) : accounts;
        var list = arr[returnCurIndex()].cart;
        if (list.length > 0) {
            loadCartItem(list, (total, totalAmount) => {
                document.getElementById("checkout__cart-total-amount").innerText = `${totalAmount}`;
                total = addComma(total);
                document.getElementById("checkout__cart-total-money").innerText = `${total} ₫`;
                renderCartNotify(list)
                document.querySelector('.section__notify-footer-text').innerText = `Tổng tiền (${totalAmount}) sản phẩm: `
                document.querySelector('.section__notify-footer-money').innerText = `${total} ₫`
            });
            initCart();
        }
        else {
            getNoProductCart();
        }
    }
}

// Tính thành tiền của từng sản phẩm
function tinhThanhTien(price, size, amount) {
    return parseInt(amount * (deleteComma(price) + parseInt(size === 'S' ? 0 : (size === 'M' ? 20000 : 50000))))
}

// Load các sản phẩm lên giỏ hàng
function loadCartItem(items, callback) {
    var cartList = document.querySelector(".checkout__cart-products");
    cartList.innerHTML = "";
    var total = 0, totalAmount = 0;
    items.forEach((item, index) => {
        var sum = tinhThanhTien(item.price, item.size, item.amount);
        total += sum;
        totalAmount += parseInt(item.amount);
        sum = addComma(sum);
        cartList.innerHTML += `<div class="checkout__cart-product">
                                <img src="${item.image}">
                                <div class="product-info">
                                    <div class="product-name-one">Tên Món: </div>
                                    <h3 class="product-name">${item.name}</h3>
                                    <div class="product-price-one">Đơn Giá: </div>
                                    <h4 class="product-price">${item.price}VND</h4>
                                </div>
                                <div class="product-info-two">
                                    <div class="product-size-quanti">
                                        <div class="product-amount" style="margin: 0;">
                                            <div class="product-text">Số lượng:</div>
                                            <input class="checkout__amount" value="${item.amount}" type="number" min="1" data-index="${index}">
                                        </div>
                                        <div class="product-size">
                                            <div class="product-text">Size:</div>
                                            <div class="product-size-value">${item.size}</div>
                                        </div>
                                    </div>
                                    <div class="product-size">
                                        <div class="product-text">Thành tiền:</div>
                                        <div class="product-size-value">${sum} VND</div>
                                    </div>
                                </div>
                                
                                <div class="product-remove">
                                    <i class="fa fa-trash" aria-hidden="true"></i>
                                    <span class="checkout__remove-name" data-index="${index}">Xóa</span>
                                </div>
                            </div>`;
    });
    document.querySelector('.section__notify-footer-text').innerText = `Tổng tiền (${totalAmount}) sản phẩm: `
    document.querySelector('.section__notify-footer-money').innerText = `${total} ₫`
    callback(total, totalAmount);   
}

// Render thông tin mua hàng ra thông báo
function renderCartNotify(arr) {
    var notifyCart = document.querySelector('.section__notify-cart-list');
    notifyCart.innerHTML = '';

    for(let i=0; i < arr.length; i++) {
        notifyCart.innerHTML += `<li class="section__notify-cart-item">
                                    <img src="${arr[i].image}" alt="">
                                    <div class="section__notify-cart-info">
                                        <div class="section__notify-cart-name">${arr[i].name}</div>
                                        <div class="section__notify-cart-quantity">
                                            <div class="section__notify-cart-amount">Số lượng: ${arr[i].amount}</div>
                                            <div class="section__notify-cart-size">Size: ${arr[i].size}</div>
                                        </div>
                                        <div class="section__notify-cart-price">${arr[i].price}</div>
                                    </div>
                                </li>`
    }
}

// ** Xử lý xem trang người dùng và đơn hàng đã đặt

// Ẩn sidebar và các section
function hideSidebar() {
    document.querySelector('.sidebar').style.display = 'none';
    document.getElementById('main').style.gridTemplateColumns = '1fr';
    document.querySelector('.section').style.padding = '25px 0px ';
    sectionContents.forEach(function(item) {
        item.style.display = 'none';
    })
}

function showSidebar() {
    document.querySelector('.sidebar').style.display = 'flex';
    document.getElementById('main').style.gridTemplateColumns = '100px 1fr';
    document.querySelector('.section').style.padding = '25px 25px 0px 25px';
    sectionContents.forEach(function(item, index) {
        if(index === 3) {
            item.style.display = 'flex';
        }
        else
            item.style.display = 'block';
    })
    // window.location.pathname = 'index.html';
}

var tongTienTatCaDonHang = 0; // lưu tổng tiền từ tất cả các đơn hàng đã mua
var tongSanPhamTatCaDonHang = 0;

// Bấm vào để vô trang người dùng
document.querySelector('.section__login-order').addEventListener('click', function() {
    hideSidebar();

    document.querySelector('.donHangDaDat').style.display = 'block';
})

function showOrder() {
    var arr = localStorage.getItem("account") ? JSON.parse(localStorage.getItem("account")) : accounts;
    if(returnCurIndex() != -1) {
        var arrOrder = arr[returnCurIndex()].donhang;
        if(arrOrder.length > 0) {
            for(let i=0; i < arrOrder.length; i++) {
                addDonHang(arrOrder[i])
            }
        }
        else {
            document.getElementsByClassName('listOrder')[0].innerHTML = `<h2 style="color: red; font-weight:bold; text-align:center; font-size: 36px; padding: 50px;">
                                                                            Bạn chưa có đơn hàng nào !!
                                                                        </h2>`;
        }
        addInfoUser(arr)
    }
}

showOrder();

// Phần Thông tin người dùng
function addInfoUser(arr) {
    document.getElementsByClassName('infoUser')[0].innerHTML = `
    <hr>
    <table>
        <tr>
            <th colspan="3">THÔNG TIN KHÁCH HÀNG</th>
        </tr>
        <tr>
            <td>Tài khoản: </td>
            <td> <span>${arr[returnCurIndex()].Username}</span> </td>
        </tr>
        <tr>
            <td>Mật khẩu: </td>
            <td> <span>${arr[returnCurIndex()].Password}</span> </td>
        </tr>
        <tr>
            <td colspan="3" style="padding:5px; border-top: 1px solid #ccc;"></td>
        </tr>
        <tr>
            <td>Họ tên: </td>
            <td> <span>${arr[returnCurIndex()].Fullname}</span> </td>
        </tr>
        <tr>
            <td>Email: </td>
            <td> <span>${arr[returnCurIndex()].email}</span> </td>
        </tr>
        <tr>
            <td colspan="3" style="padding:5px; border-top: 1px solid #ccc;"></td>
        </tr>
        <tr>
            <td>Tổng tiền đã mua: </td>
            <td> <span>${addComma(tongTienTatCaDonHang)} ₫</span> </td>
        </tr>
        <tr>
            <td>Số lượng sản phẩm đã mua: </td>
            <td> <span>${tongSanPhamTatCaDonHang}</span> </td>
        </tr>
    </table>
    <hr>`;
}

// Phần Thông tin đơn hàng đã đặt
function addDonHang(donhang) {
    var div = document.getElementsByClassName('listOrder')[0];
    var sanpham = donhang.sanpham;

    var s = `
            <table class="listSanPham">
                <tr> 
                    <th colspan="6">
                        <i class="fa-solid fa-arrow-down"></i>
                        <h3 style="text-align:center; line-height: 30px;"> Đơn hàng ngày: ${getCurDate()}</h3> 
                    </th>
                </tr>
                <tr class="not-show">
                    <th>STT</th>
                    <th>Sản phẩm</th>
                    <th>Giá</th>
                    <th>Size</th>
                    <th>Số lượng</th>
                    <th>Thành tiền</th>
                </tr>`;

    for(let i=0; i < sanpham.length; i++) {
        var thanhTien = tinhThanhTien(sanpham[i].price, sanpham[i].size, sanpham[i].amount);
        s += `<tr class="not-show">
                <td>${i + 1}</td>
                <td class="noPadding imgHide">
                    <a>
                        ${sanpham[i].name}
                        <img src="${sanpham[i].image}">
                    </a>
                </td>
                <td>${sanpham[i].price} ₫</td>
                <td class="sizeSP" >${sanpham[i].size}</td>
                <td class="soluong" >${sanpham[i].amount}</td>
                <td>${addComma(thanhTien)} ₫</td>
            </tr>`;

    }

    tongSanPhamTatCaDonHang += parseInt(donhang.soluong);
    tongTienTatCaDonHang += parseInt(deleteComma(donhang.tongtien));

    var switchColor;
    if(donhang.trangthai == 'Đã xử lý') {
        switchColor = 'active';
    }
    else {
        switchColor = '';
    }

    s += `<tr style="font-weight:bold; text-align:center; height: 4em; font-size: 18px;">
                <td colspan="4">TỔNG TIỀN: </td>
                <td>${donhang.tongtien}</td>
                <td class="${switchColor}">${donhang.trangthai}</td>
            </tr>
        </table>
        <hr>`;

    div.innerHTML += s;
}

//  
const scrollOrder = document.querySelectorAll('.listSanPham tr:first-child');

scrollOrder.forEach(function(item, index) {
    item.onclick = function() {
        var listSP = document.querySelectorAll('.listSanPham')[index];
        var a = listSP.querySelectorAll('tr.not-show');

        if(a.length > 0) {
            for(let i=0; i < a.length; i++) {
                a[i].classList.remove('not-show');
            }
            listSP.querySelector('tr th i').classList.remove('fa-arrow-down');
            listSP.querySelector('tr th i').classList.add('fa-arrow-up');
        }
        else {
            var b = listSP.querySelectorAll('tr');
            for(let i=1; i < b.length - 1; i++) {
                b[i].classList.add('not-show');
            }
            listSP.querySelector('tr th i').classList.remove('fa-arrow-up');
            listSP.querySelector('tr th i').classList.add('fa-arrow-down');
        }
    }
})

// Bấm vào để đăng xuất
document.querySelector('.section__login-back').addEventListener('click', function() {
    showSidebar();
    getNoProductCart();
})

// ==> Gọi các hàm để thực hiện xử lý

updateCart();
sidebarControl();
sectionControl(sectionItems);
scrollTopHandle();
checkAccount();
